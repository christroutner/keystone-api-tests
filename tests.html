<!DOCTYPE html>

<!--
Note: You'll need the bootstrap css and js files and change the paths to them below.
-->

<html lang="en">
<head>
  <title>KeystoneJS API Example</title>

  <link href="css/bootstrap.min.css" media="all" rel="stylesheet" />
</head>
<body>


  <section>
    <div class='container'>
      <div class="row well well-lg">
        <div class="col-md-12">
          <!--
          <img id="image1" src="" alt="" width="600px" />
          <br><br>
          <img id="image2" src="" alt="" width="600px" />
          <br><br>
          <img id="image3" src="" alt="" width="600px" />
          -->
          
          <!--
          <form>
            <div class="form-group">
              <label for="testOutput">Test Output:</label>
              <textarea class="form-control" rows="40" style="overflow-y: scroll;" id="testOutput"></textarea>
            </div>
          </form>
          -->
          
          <div id="testOutput"></div>
          
        </div>
      </div>
    </div>
  </section>

  <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>
  <script src="js/bootstrap.min.js?body=1"></script>

  <script type="text/javascript">
    //Global Variables
    var serverIP = '<your ip address>';
    var serverIP = '192.241.198.211';
    
    var isLoggedIn = false;
    
    var testCnt = 1;
    
    //First function that is called when the document finishes loading.
    $(document).ready( function() {
    
      //Get user session information. Determine if user is logged in or not.
      $.get('/keystone/api/session', '', function(data) {
        //debugger;
        
        appendOutput("Test $.get(/keystone/api/session) - PASSED")
        //console.log('Test 1: /api/session PASSED');
        testCnt++;
        console.log('After $.get(/keystone/api/session), server returned...');
        console.log(data);
        
        //Test if the user is logged in.
        isLoggedIn = !$.isEmptyObject(data);
        
        if(isLoggedIn) {
          console.log('You are logged into KeystoneJS.');
          console.log('');
          
          //For now, I'm just going to write tests if the user is logged in. Most API calls return a sign-in page if the user is not logged in.
          //This call intentially creates an error
          runLoggedInTests();
        } else {
          console.log('You are NOT logged in.');
          console.log('');
        }
        
      }).fail( function() {
        appendOutput("Test $.get(/keystone/api/session) - Server did not resond!")
        console.error('$.get(/keystone/api/session failed.)') ;
      });
      
      
      
    });
    
    //These tests are run when the user is logged in.
    function runLoggedInTests() {
      
      //For now, I'm just going to write tests if the user is logged in. Most API calls return a sign-in page if the user is not logged in.
      //This call intentially creates an error
      if(isLoggedIn) {
        //debugger;
        
        //Get a list that doesn't exist.
        $.get('/keystone/api/test', '', function(data) {debugger})
          .fail(function( jqxhr, textStatus, error ) {
            //debugger;
            
            if(jqxhr.status == 500)
              console.log('Test '+testCnt+': /api/test PASSED');
            else
              console.log('Test '+testCnt+': /api/test FAILED');
            testCnt++;
            
            console.log('Expected: 500 (server error)');
            console.log('Server returned: '+jqxhr.status+' ('+error+')');
            
            console.log('');
          
          });


        //Get /api/users
        $.get('/keystone/api/users', '', function(data) {
          //debugger
          
          console.log('Test '+testCnt+': get(/api/users) PASSED');
          console.log('First user found is '+data.results[0].name+' with ID '+data.results[0].id);
          console.log('');
          testCnt++;
          
          testListItemUpdate(data.results[0]);
        })
        .fail(function( jqxhr, textStatus, error ) {
          //debugger;
          
          console.log('Test '+testCnt+': get(/api/users) FAILED');
          console.log('Server returned: '+jqxhr.status+'('+error+')');
          console.log('');
          testCnt++;
        });
        

      }
    }
    
    //This test expects to be passed a User list item object. It tests the ability
    //to update a list item by changing the name of the user.
    function testListItemUpdate(userItem) {
      //debugger;
      
      var originalUserName = userItem.name;
      
      //Error handling
      if(originalUserName == undefined) {
        console.log('Invalid user data passed to testListItemUpdate()');
        return;
      }
      
      userItem.name = "Test Name";
      
      //NOTE: Not sure what the right 'update' path is, so trying multiple.
      
      //Update the user name. TRY 1
      $.post('/keystone/api/users/'+userItem.id, userItem, function(data) {
        //debugger;
        
        console.log('Test '+testCnt+': post(/api/users/userID) PASSED');
        console.log('Original user name was '+originalUserName+'. Name updated to: Test Name');
        console.log('');
        testCnt++;
        
      //Catch failures
      }).fail(function( jqxhr, textStatus, error ) {
        //debugger;
        
        console.log('Test '+testCnt+': post(/api/users/userID) FAILED');
        console.log('Server returned: '+jqxhr.status+' ('+error+')');
        console.log('');
        testCnt++;
      });
     
    }
    
    
    //This function is used to write the output of test results to the page.
    function appendOutput(text, style) {
      debugger;
    }
  </script>
  
</body>
</html>
 